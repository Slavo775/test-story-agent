# AI Gen Setup Guide

This guide explains how to integrate the AI Agent into your project.  
The agent generates **Storybook stories**, **unit tests**, and **integration tests**, then opens a PR with the changes.

---

## 1. Requirements

- Node.js **>= 20**
- `pnpm`
- `git`
- Push access to the repository (via HTTPS+PAT or SSH)
- (only for "real" runs) API keys:
  - `ANTHROPIC_API_KEY` (Claude API)
  - `GITHUB_PERSONAL_ACCESS_TOKEN` or `GITHUB_TOKEN` (to open PRs)

---

## 2. Install the Agent

### Option A – as a package (recommended)

```bash
pnpm add -D @yourorg/ai-gen
```

### Option B – as a local tool

Copy the `cli/` folder into your repo.  
Run:

```bash
pnpm -C cli build && node cli/dist/cli.js
```

---

## 3. Create a Configuration File

At the root of your repo, create **`ai-gen.config.json`**. Example:

```json
{
  "branchBase": "master",
  "branchPrefix": "ai-gen/",
  "prPrefix": "[AI-gen] ",
  "reviewers": ["your-github-username"],
  "features": {"storybook": true, "unit": true, "integration": true},
  "paths": {
    "components": [
      "apps/web/src/**/*.{tsx,ts}",
      "packages/ui/src/**/*.{tsx,ts}"
    ],
    "exclude": [
      "**/*.stories.*",
      "**/*.test.*",
      "**/*.spec.*",
      "**/pages/**",
      "**/app/**"
    ]
  },
  "targets": {
    "storybook": {"mode": "co-locate", "folder": "apps/web/src/stories"},
    "unit": {"mode": "co-locate", "folder": "tests/unit"},
    "integration": {"folder": "tests/integration"}
  },
  "overwritePolicy": "generated-only",
  "fileHeader": "// @ai-generated by ai-gen. Do not edit manually.",
  "llm": {
    "provider": "anthropic",
    "model": "claude-3-5-sonnet-20240620",
    "baseUrl": "https://api.anthropic.com",
    "temperature": 0.2
  }
}
```

---

## 4. Environment Variables

- **Dry-run mode** → nothing required.
- **Real run**:

```bash
export GITHUB_PERSONAL_ACCESS_TOKEN=ghp_xxx   # or GITHUB_TOKEN in CI
export ANTHROPIC_API_KEY=sk-ant-...
export DEFAULT_GH_OWNER=owner
export DEFAULT_GH_REPO=repo
```

---

## 5. Run the Agent

### Dry-run (safe, no API calls, no file writes)

```bash
npx ai-gen --mode changed --dry-run
npx ai-gen --mode pr:147 --dry-run
npx ai-gen --mode full --dry-run
```

You’ll see a plan of what _would_ be generated.  
No LLM calls, no commits, no costs.

### Real execution

```bash
# For changed files only (vs branchBase)
npx ai-gen --mode changed --owner owner --repo repo

# For a specific PR (diff from PR #147)
npx ai-gen --mode pr:147 --owner owner --repo repo

# For the whole repo
npx ai-gen --mode full --owner owner --repo repo
```

The agent will:

1. Create a branch `ai-gen/<timestamp>` from `branchBase`.
2. Generate files (storybook/tests) according to your config.
3. Commit and push changes.
4. Open a PR with prefix `[AI-gen]` and assign reviewers.

---

## 6. NPM Scripts (optional)

Add to `package.json`:

```json
{
  "scripts": {
    "ai:plan": "ai-gen --mode changed --dry-run",
    "ai:plan:pr": "ai-gen --mode pr:147 --dry-run",
    "ai:run": "ai-gen --mode changed",
    "ai:run:full": "ai-gen --mode full"
  }
}
```

---

## 7. GitHub Actions (optional)

Create `.github/workflows/ai-gen.yml`:

```yaml
name: AI: Generate PR
on:
  workflow_dispatch:
    inputs:
      mode:
        type: choice
        options: [changed, full, pr]
        default: changed
      prNumber:
        required: false
      files:
        required: false

permissions:
  contents: write
  pull-requests: write

jobs:
  ai-gen:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - uses: pnpm/action-setup@v4
        with: { version: 9 }
      - uses: actions/setup-node@v4
        with: { node-version: 20, cache: 'pnpm' }

      - name: Install CLI
        run: pnpm add -D @yourorg/ai-gen

      - name: Run generator
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          DEFAULT_GH_OWNER: ${{ github.repository_owner }}
          DEFAULT_GH_REPO: ${{ github.event.repository.name }}
        run: |
          MODE="${{ inputs.mode }}"
          PRNUM="${{ inputs.prNumber }}"
          FILES="${{ inputs.files }}"
          CMD="npx ai-gen --mode ${MODE}"
          if [ "$MODE" = "pr" ] && [ -n "$PRNUM" ]; then
            CMD="npx ai-gen --mode pr:${PRNUM}"
          fi
          if [ -n "$FILES" ]; then
            CMD="$CMD --files \"$FILES\""
          fi
          eval $CMD
```

---

## 8. Tips for cheap testing

- Always start with `--dry-run` → free, no API calls.
- Use `AI_GEN_CACHE=1` → caches LLM output by hash (no duplicate calls).
- Use `--limit 1` with a cheaper model (Claude Haiku) for smoke tests.
- Use `--write-dir .ai-gen-out --no-commit` → generates into sandbox dir, no commits.
